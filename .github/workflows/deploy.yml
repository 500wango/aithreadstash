name: Deploy to VPS

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'frontend-website/**'
      - '.github/workflows/deploy-frontend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH to VPS
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: michael
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            # Ensure node/npm/pm2 available in non-interactive shell (nvm or system install)
            if [ -s "$HOME/.nvm/nvm.sh" ]; then
              . "$HOME/.nvm/nvm.sh"
              # optional: choose a default node version if needed
              nvm use --silent default || true
            fi
            export PATH="$HOME/.local/bin:$PATH"

            # Install pm2 globally if not present
            if ! command -v pm2 >/dev/null 2>&1; then
              npm i -g pm2
            fi

            # Go to deploy directory (must exist and owned by michael)
            cd /srv/aithreadstash

            # Pull latest code if repo exists; otherwise clone this repo
            if [ -d .git ]; then
              git fetch --all
              git reset --hard origin/main
            else
              git clone ${{ github.server_url }}/${{ github.repository }} .
            fi

            # Backend: install, build and run migrations
            cd backend
            npm ci
            npm run build
            npm run migration:run
            pm2 start ecosystem.config.js --env production || true

            # Frontend: install, build and start SSR
            cd /srv/aithreadstash/frontend-website
            npm ci
            npm run build
            pm2 start ecosystem.config.js --env production || true

            # Save PM2 state
            pm2 save